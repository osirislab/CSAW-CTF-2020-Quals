/*
 * libgoaway.c
 *
 *   Implements the anti-reversing library functionality for the main executable.
 *   Uses the following components in order to slow down introspection:
 *      - Simple `ptrace` TRACE_ME check to check for a debugging process
 *		- cpuid-based anti-vm check to check for hypervisor usage
 */
#include "goaway.h"

#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <string.h>
#include <fcntl.h>

#include <sys/ptrace.h>
#include <sys/stat.h>
#include <sys/mman.h>

#define HYPERVISOR_INFO 0x40000000

static inline void
cpuid(uint32_t *eax, uint32_t *ebx, uint32_t *ecx, uint32_t *edx)
{
    asm volatile("cpuid"
        : "=a" (*eax),
          "=b" (*ebx),
          "=c" (*ecx),
          "=d" (*edx)
        : "0" (*eax), "2" (*ecx));
}


/* use cpuid to check for hypervisor/vm vendor */
void hypervisors_are_scary(void) {
	uint32_t eax;
	char string[13];

	eax = 0;
	string[12] = 0;

	cpuid(&eax, (uint32_t *) &string[0], (uint32_t *) &string[8], (uint32_t *) &string[4]);

	if (
		(strncmp(string, "VMwareVMware", 12) == 0) || (strncmp(string, "KVMKVMKVM", 12) == 0) || \
		(strncmp(string, "TCGTCGTCGTCG", 12) == 0) || (strncmp(string, "Microsoft Hv", 12) == 0) || \
		(strncmp(string, " lrpepyh vr", 12) == 0)
	) {
		exit(EXIT_FAILURE);
	}
}


/* stop preloading - can be easily patched out */
void no_sneaky_loading(void) {
	if(getenv("LD_PRELOAD"))
		exit(EXIT_FAILURE);
    if(open("/etc/ld.so.preload", O_RDONLY) > 0)
		exit(EXIT_FAILURE);
}

/* simple anti-ptrace/debug detection - can be easily patched out */
void stop_intruders(void) {
    if (ptrace(PTRACE_TRACEME, 0, 1, 0) == -1)
        exit(EXIT_FAILURE);
}
