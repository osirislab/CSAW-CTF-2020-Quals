/*
 * libgoaway.c
 *
 *   Implements the anti-reversing library functionality for the main executable.
 *   Uses the following components in order to slow down introspection:
 *      - Simple `ptrace` TRACE_ME check to check for a debugging process
 *		- cpuid-based anti-vm check to check for hypervisor usage
 */
#include "goaway.h"

#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <string.h>

#include <sys/ptrace.h>
#include <sys/mman.h>

#define HYPERVISOR_INFO 0x40000000

/* use cpuid to check for hypervisor vendor
void hypervisors_are_scary(void) {
	unsigned int eax, ebx, ecx, edx;
	char string[13];

	CPUID (HYPERVISOR_INFO, &eax, &ebx, &ecx, &edx);
	*(unsigned int *) (string + 0) = ebx;
	*(unsigned int *) (string + 4) = ecx;
	*(unsigned int *) (string + 8) = edx;

	string[12] = 0;
	if (strncmp (string, "XenVMMXenVMM", 12) == 0)
		printf ("Xen HVM\n");
	else if (strncmp (string, "VMwareVMware", 12) == 0)
		printf ("VMware\n");
	else if (strncmp (string, "KVMKVMKVM", 12) == 0)
		printf ("KVM\n");
}*/

/* stop preloading - can be easily patched out */
void no_sneaky_loading(void) {
}

/* simple anti-ptrace/debug detection - can be easily patched out */
void stop_intruders(void) {
    if (ptrace(PTRACE_TRACEME, 0, 1, 0) == -1)
        exit(EXIT_FAILURE);
}
